---

- name: "Install sudo"
  package:
    name: sudo
    state: present

- name: "Create sudo group"
  group:
    name: sudo
    state: present
 
- name: "Create user"
  user:
    name: "{{ user }}"
    groups: sudo
    append: true
    state: present

- name: "Allow sudo group passwordless sudo"
  lineinfile:
    path: /etc/sudoers
    line: "sudo ALL=(ALL) NOPASSWD: ALL"
    create: yes
    validate: /usr/sbin/visudo -cf %s

- name: "Disable root SSH login"
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "PermitRootLogin yes"
    line: "PermitRootLogin no"
  notify: Restart SSH

- name: Check if EPEL repo is already configured.
  stat:
    path: "{{ epel_repofile_path }}"
  register: epel_repofile_result
  when: ansible_distribution == 'CentOS'
 
- name: Install EPEL repo.
  yum:
    name: "{{ epel_repo_url }}"
    state: present
  register: result
  when: not epel_repofile_result.stat.exists and ansible_distribution == 'CentOS'
 
- name: Import EPEL GPG key.
  rpm_key:
    key: "{{ epel_repo_gpg_key_url }}"
    state: present
  when: not epel_repofile_result.stat.exists and ansible_distribution == 'CentOS'

- name: "Copy ansible SSH key"
  authorized_key:
    user: "{{ user }}"
    state: present
    key: "{{ lookup('file', '/home/{{ user }}/.ssh/id_rsa.pub') }}"

